<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../vaadin-dialog/vaadin-dialog.html">


<dom-module id="mist-filter">
    <template>
        <style>
            [hidden] {
                display: none !important;
            }

            :host {
                display: inherit;
            }

            span.title {
                font-size: 18px !important;
                text-transform: capitalize;
                font-weight: 500;
                opacity: .7;
            }

            h2.titleh2 {
                line-height: 1.1em !important;
                margin: var(--mist-filter-h2-title-margin);
                width: 100%;
            }

            #form {
                display: inherit;
                max-height: 48px;
                flex: 1 100%;
            }

            paper-input {
                width: 100%;
                top: -13px;
                padding-left: 8px;
            }

            paper-input#searchInput {
                width: 100%;
                --paper-input-container-input: {
                    font-size: 16px;
                    color: inherit;
                    width: 100%;
                    padding: 5px 0;
                }
            }

            paper-item paper-icon-button {
                transform: scale(0.7);
                opacity: 0.54;
            }

            paper-icon-button#saveFilterBtn,
            paper-icon-button#clearFilterBtn {
                display: inline-flex;
                align-self: center;
                margin-top: var(--mist-filter-paper-buttons-margin-top);
            }

            paper-menu-button {
                padding: var(--mist-filter-paper-menu-button-padding);
                max-height: 48px;
            }

            paper-menu-button paper-button {
                background-color: var(--mist-filter-paper-menu-button-background-color);
                margin: var(--mist-filter-paper-menu-button-paper-button-margin);
                padding-left: var(--mist-filter-paper-menu-button-paper-button-padding-left);
                text-transform: var(--mist-filter-paper-menu-button-paper-button-text-transform);
                font-size: var(--mist-filter-paper-menu-button-paper-button-font-size);
            }

            iron-icon[icon="search"] {
                padding: 12px 8px 8px 0px;
                align-self: var(--mist-filter-iron-icon-search-align-self);
                opacity: .5;
            }

        </style>
        
        <paper-menu-button id="presetFilters" horizontal-align="left" vertical-align="top" vertical-offset="40" hidden$="[[!combinedPresetFilters.length]]">
            <template is="dom-if" if="[[!_showButton(buttonName)]]" restamp>
                    <paper-icon-button icon="filter-list" slot="[[_computeSlot(buttonName,'icon')]]" class="dropdown-trigger" alt="select filter"title="Select preset filters" style="margin-left: -10px; margin-right: 4px" hidden$="[[buttonName.length]]"></paper-icon-button>
            </template>
            <template is="dom-if" if="[[_showButton(buttonName)]]" restamp>
                <paper-button class="dropdown-trigger" slot="[[_computeSlot(buttonName,'button')]]" hidden$="[[!buttonName.length]]" style="height: 48px;"> [[buttonName]]<iron-icon icon="icons:arrow-drop-down"></iron-icon>
                </paper-button>
            </template>
            <paper-listbox id="filterSelect" slot="dropdown-content" class="dropdown-content" attr-for-selected="id" selected="{{selectedPresetFilter}}">
                <paper-item id="" class="filter all-items" on-tap="_clearFilter"><span>[[name]]</span></paper-item>
                <template is="dom-repeat" items="[[combinedPresetFilters]]">
                    <paper-item id$="[[item.filter]]" class="filter">
                        <paper-item-body>[[item.name]]</paper-item-body>
                        <paper-icon-button class="clear-filter" icon="icons:delete" title="Delete filter" on-tap="_deletePresetFilter"
                            hidden$="[[item.default]]"></paper-icon-button>
                    </paper-item>
                </template>
            </paper-listbox>
        </paper-menu-button>

        <div id="form" on-tap="_startEditingFilter">
            <iron-icon icon="search" hidden$=[[_hideSearchIcon(searchable,placeholder)]]></iron-icon>
            <slot name="count"></slot>
            <h2 class="titleh2" hidden$=[[_showFilterInput(editingFilter,alwaysShowInput)]]>
                <span class="title">
                    [[_displayName(name,selectedPresetFilter,userFilter,combinedPresetFilters)]]
                </span>
            </h2>
            <paper-input id="searchInput" hidden$=[[!_showFilterInput(editingFilter,alwaysShowInput)]] on-focused-changed="_searchInputFocusedChanged"
                on-keydown="_keyDownSearchInput" tabindex="1" value="{{userFilter}}" no-label-float placeholder$="[[placeholder]]">
            </paper-input>
        </div>
        <paper-icon-button icon="close" hidden$=[[_hideClearButton(editingFilter,userFilter.length)]] on-tap="_clearFilter" id="clearFilterBtn"></paper-icon-button>
        <paper-icon-button on-tap="_openDialogSaveFilter" icon="icons:save" hidden$="[[!showSaveSearch]]" id="saveFilterBtn">save
            filter</paper-icon-button>
        <vaadin-dialog id="filterDialog" aria-label="styled">
            <template>
                <h2>Save filter</h2>
                <div class='vaadin-dialog-scrollable'>
                    <span>Optionally choose a filter name.</span>
                    <paper-input id="filterName" value="{{filterName}}" label="Filter name" tabindex="1" autofocus
                        on-keydown="_keyDownFilterName"></paper-input>
                </div>
                <div class="buttons">
                    <paper-button on-tap="_dismissFilterDialog">Cancel</paper-button>
                    <paper-button dialog-confirm on-tap="_saveFilter">Save</paper-button>
                </div>
            </template>
        </vaadin-dialog>

    </template>
</dom-module>
<script>
    Polymer({
        is: 'mist-filter',
        properties: {
            name: {
                type: String,
                reflectToAttribute: true
            },

            placeholder: {
                type: String
            },

            buttonName: {
                type: String,
                value: false
            },

            editingFilter: {
                type: Boolean,
                value: false
            },

            alwaysShowInput:  {
                type: Boolean,
                value: false,
                reflectToAttribute: true
            },

            baseFilter: {
                type: String,
                value: "",
                observer: '_baseFilterUpdated'
            },

            userFilter: {
                type: String,
                notify: true
            },

            combinedFilter: {
                type: String,
                computed: '_computeFilter(baseFilter, userFilter)',
                notify: true
            },

            presetFilters: {
                type: Array,
                value: function(){
                    return [];
                }
            },

            userSavedFilters: {
                type: Array,
                value: function(){
                    return [];
                }
            },

            combinedPresetFilters: {
                type: Array,
                value: function(){
                    return [];
                },
                computed: '_computeCombinedPresetFilters(presetFilters,userSavedFilters,userSavedFilters.length)'
            },

            selectedPresetFilter: {
                type: String,
                value: '',
                observer: '_selectedPresetFilterChanged'
            },

            filterName: {
                type: String
            },

            searchable: {
                type: Boolean,
                value: true
            },

            showSaveSearch: {
                type: Boolean,
                computed: '_computeShowSaveSearch(userFilter,combinedPresetFilters.length)'
            }
        },

        observers: [
            '_userFilterChanged(userFilter)',
            '_editingFilterChanged(editingFilter)'
        ],

        attached: function () {
            this.getLocalStorageData(this.id)
        },

        getLocalStorageData: function(id) {
            try {
                if (localStorage.getItem('mist-filter#' + this.id + '/userFilter') != undefined) {
                    this.set('userFilter', localStorage.getItem('mist-filter#' + this.id + '/userFilter'));
                } else if (localStorage.getItem('mist-filter#default/userFilter') && this.id.endsWith('List')) {
                    this.set('userFilter', localStorage.getItem('mist-filter#default/userFilter'));
                } else {
                    this.set('userFilter', '');
                }
                console.log('get userFilter', this.userFilter)
                this.$.filterSelect.select(this.userFilter);
                // let display input if there is a query stored, which dows not belong to saved filters 
                if (!this.$.filterSelect.selectedItem || this.$.filterSelect.selectedItem.filter != this.userFilter) {
                    this.set('editingFilter', true);
                }

                if (JSON.parse(localStorage.getItem('mist-filter#' + this.id + '/userSavedFilters'))) {
                    this.set('userSavedFilters', JSON.parse(localStorage.getItem('mist-filter#' + this.id +
                        '/userSavedFilters')));
                    this.dispatchEvent(new CustomEvent('filter-change', { bubbles: true, composed: true}));
                } else {
                    this.set('userSavedFilters', [])
                }
            } catch (e) {
                console.warn('Failed to access localStorage: ', e);
            }
        },

        _selectedPresetFilterChanged: function (filters) {
            this.set('userFilter', this.selectedPresetFilter);
        },

        addFilter: function (filter) {
            this.push('userSavedFilters', filter);
            localStorage.setItem('mist-filter#' + this.id + '/userSavedFilters', JSON.stringify(this.userSavedFilters));
            this.dispatchEvent(new CustomEvent('filter-change', { bubbles: true, composed: true}));
            this.set('editingFilter', false);
        },

        deleteFilter: function (index) {
            console.log('_deleteFilter IN', index);
            this.splice('userSavedFilters', index, 1);
            localStorage.setItem('mist-filter#' + this.id + '/userSavedFilters', JSON.stringify(this.userSavedFilters));
            this.dispatchEvent(new CustomEvent('filter-change', { bubbles: true, composed: true}));
        },

        useFilter: function (filter) {
            if (typeof filter == "object" && filter.filter) {
                this.set('userFilter', filter.filter);
            }
            if (typeof filter == "string") {
                this.set('userFilter', filter);
            }
            this.set('selectedPresetFilter', this.userFilter);
        },

        _displayName: function (name, selectedPresetFilter, userFilter) {
            if (!this.selectedPresetFilter || !this.selectedPresetFilter.length) {
                return this.name && this.name.length ? this.name : 'All';
            } else {
                var that = this,
                    filter = this.combinedPresetFilters.find(function (f) {
                        return that.selectedPresetFilter == f.filter;
                    });
                return filter ? filter.name : '';
            }
        },

        _openDialogSaveFilter: function (e) {
            this.set('filterName', this.userFilter.slice(0));
            this.$.filterDialog.opened = true;
        },

        _dismissFilterDialog: function (e) {
            this.$.filterDialog.opened = false;
        },

        _saveFilter: function (e) {
            if (this.presetFilters.map(function (m) {
                    return m.filter;
                }).indexOf(this.userFilter.trim()) == -1) {
                var newfilter = {
                    name: this.filterName,
                    filter: this.userFilter,
                    default: false
                };
                this.addFilter(newfilter);
            }
            this.useFilter(newfilter);
            this.$.filterDialog.opened = false;
            this.set('filterName', '');
        },

        _deletePresetFilter: function (e) {
            e.stopPropagation();
            this.deleteFilter(this.userSavedFilters.indexOf(e.model.item))
            if (this.selectedPresetFilter == e.model.item.filter) {
                this.useFilter('');
            }
            if (this.userFilter.indexOf(e.model.item.filter) > -1) {
                this.set('userFilter', this.userFilter.replace(e.model.item.filter, ""));
            }
        },

        _userFilterChanged: function (userFilter) {
            if (this.userFilter != undefined && this.isAttached) {
                var trimmed = userFilter.trim();
                console.log('passed')
                if (this.editingFilter) {
                    this._updateSelectedFilter(userFilter);
                }
                this.dispatchEvent(new CustomEvent('filter-change', { bubbles: true, composed: true}));
                localStorage.setItem('mist-filter#' + this.id + '/userFilter', this.userFilter);
            }
        },

        _updateSelectedFilter: function (userFilter) {
            var filter = this.combinedPresetFilters.find(function (f) {
                    return userFilter == f.filter;
                });
            if (filter) {
                this.set('selectedPresetFilter', this.userFilter);
            }
        },

        _computeShowSaveSearch: function (userFilter, presetFiltersLength) {
            return this.editingFilter && this.userFilter.length && !this._filterIsAPresetFilter();
        },

        _computeCombinedPresetFilters: function (presetFilters, userSavedFilters) {
            var pf = this.presetFilters || [],
                usf = this.userSavedFilters || [];
            return pf.concat(usf);
        },

        _startEditingFilter: function (e) {
            if (this.searchable) {
                this.editingFilter = true;
            }
        },

        _searchInputFocusedChanged: function (e) {
            // console.log('focus changed', e);
            if (e.target.focused) return;
            this.async(function () {
                if (!e.detail.value && this._filterIsAPresetFilter()) {
                    this.set('editingFilter', false);
                }
            }, 100);
        },

        _filterIsAPresetFilter: function () {
            return !this.userFilter.trim() || this.combinedPresetFilters.map(function (m) {
                return m.filter;
            }).indexOf(this.userFilter.trim()) > -1;
        },

        _keyDownSearchInput: function (e) {
            // ESC
            if (e.keyCode == 27) {
                // exit editing if there is a filter enabled
                if (this.selectedPresetFilter == this.userFilter) {
                    this.set('editingFilter', false);
                }
                // inform consumer of ESC events
                this.dispatchEvent(new CustomEvent('escape-pressed', {composed: true, bubbles: true}))
            }
            // ENTER
            if (e.keyCode === 13 && this.$.searchInput.focused) {
                this._updateSelectedFilter(this.userFilter);
                // stop editing only if 
                if (this.userFilter == this.selectedPresetFilter) {
                    this.set('editingFilter', false);
                }
            }
        },

        _keyDownFilterName: function (e) {
            // ENTER
            if (e.keyCode === 13 && this.$.filterDialog.opened) {
                this._saveFilter();
            }
        },

        _clearFilter: function (e) {
            if (this.autoHide) {
                this.autoHide = false;
                this.async(function () {
                    this.autoHide = true;
                }.bind(this), 1000);
            }
            this.set('userFilter', '');
            this.set('selectedPresetFilter', '');
            this.set('editingFilter', false);
        },

        _baseFilterUpdated: function () {
            // Reset the user defined filter every time the base filter gets updated
            if (this.userFilter) {
                this.set('userFilter', '');
            }
            this.editingFilter = false;
        },

        _editingFilterChanged: function (editingFilter) {
            // console.log('_editingFilterChanged', editingFilter, this.editingFilter);
            this.async(function () {
                console.log('async', this.$.searchInput.focused);
            }, 100);
            if (this.editingFilter) {
                if (this.$.searchInput.focused) {
                    // this.$.searchInput.focus();
                }
                this.$.searchInput.shadowRoot.querySelector('input').focus()
                // console.log('focus', this.$.searchInput.focused);
            } else {
                if (this.$.searchInput.focused) {
                    this.$.searchInput.blur();
                }
            }
        },

        _computeFilter: function (baseFilter, userFilter) {
            if (!baseFilter)
                return userFilter;
            if (!userFilter)
                return baseFilter;
            return '(' + baseFilter + ') AND (' + userFilter + ')';
        },

        _showFilterInput: function(editingFilter, alwaysShowInput) {
            return this.alwaysShowInput ? this.alwaysShowInput : this.editingFilter;
        },

        _showButton: function(buttonName) {
            return this.buttonName;
        },

        _computeSlot: function(buttonName,el) {
            if (this.buttonName.length && el == "button") {
                return 'dropdown-trigger';
            } else if (!this.buttonName.length && el == "icon") {
                return 'dropdown-trigger';
            } else {
                return "";
            }
        },

        _hideSearchIcon: function(searchable,placeholder) {
            return !this.searchable; // || this.placeholder;
        },

        _hideClearButton: function(editingFilter,userFilterLength) {
            return !this.editingFilter || this.userFilter.length == 0;
        }
    })
</script>